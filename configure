#!/bin/bash

## stolen from Rblapi

: ${R_HOME=$(R RHOME)}
SYSNAME=$(${R_HOME}/bin/Rscript -e 'cat(Sys.info()["sysname"])')

# check if PETSC_DIR is already set
DEFAULT_PETSC=$(${R_HOME}/bin/Rscript -e 'cat(Sys.getenv("PETSC_DIR")[1]=="")')

if [ ${DEFAULT_PETSC} == "TRUE" ]; then
    if [ ${SYSNAME} == "Linux" ]; then
        PETSC_DIR="/usr/local/lib/python2.7/dist-packages/petsc"
    elif [ ${SYSNAME} == "Darwin" ]; then
        PETSC_DIR="/usr/local/Cellar/petsc/3.6.3"
    else
        echo "Unsupported platform: $SYSNAME"
        exit -1
    fi
fi

# check if PETSC_ARCH is set
DEFAULT_PETSC_ARCH=$(${R_HOME}/bin/Rscript -e 'cat(Sys.getenv("PETSC_ARCH")[1]=="")')

if [ ${DEFAULT_PETSC_ARCH} == "TRUE" ]; then
    PETSC_INCLUDE=-I${PETSC_DIR}/include
    PETSC_LIB=${PETSC_DIR}/lib 
else
    PETSC_INCLUDE=-I${PETSC_DIR}/include -I${PETSC_DIR}/${PETSC_ARCH}/include
    PETSC_LIB=${PETSC_DIR}/${PETSC_ARCH}/lib 
fi

export PETSC_LIB=${PETSC_LIB}

# check if MPI_INCLUDE is  set
DEFAULT_MPI=$(${R_HOME}/bin/Rscript -e 'cat(Sys.getenv("MPI_INCLUDE")[1]=="")')
if [ ${DEFAULT_MPI} == "TRUE" ]; then
    MPI_INCLUDE=-I${PETSC_DIR}/include/petsc/mpiuni
else
    MPI_INCLUDE=-I${MPI_INCLUDE}
fi

# check if we have the libraries installed
if [ ${SYSNAME} == "Darwin" ]; then
    CHECK_PETSC=$(${R_HOME}/bin/Rscript -e 'cat(file.exists(file.path(Sys.getenv("PETSC_LIB"), "libpetsc.dylib")))')
elif [ ${SYSNAME} == "Linux" ]; then
    CHECK_PETSC=$(${R_HOME}/bin/Rscript -e 'cat(file.exists(file.path(Sys.getenv("PETSC_LIB"), "libpetsc.so")))')
fi

if [ ${CHECK_PETSC} == FALSE ]; then
    echo "Cannot find libpetsc.$ext. Please make sure PETSc is installed and PETSC_LIB is appropriately set."
    exit -1
fi

## create Makevars
sed -e"s|@PETSC_LIB@|"${PETSC_LIB}"|g" -e"s|@PETSC_INCLUDE@|"${PETSC_INCLUDE}"|g" -e"s|@MPI_INCLUDE@|"${MPI_INCLUDE}"|g" src/Makevars.in > src/Makevars

exit 0