#!/bin/bash

## stolen from Rblapi

: ${R_HOME=$(R RHOME)}
SYSNAME=$(${R_HOME}/bin/Rscript -e 'cat(Sys.info()["sysname"])')

# check if PETSC_DIR is already set
DEFAULT_PETSC=$(${R_HOME}/bin/Rscript -e 'cat(Sys.getenv("PETSC_DIR")[1]=="")')

if [ ${DEFAULT_PETSC} == "TRUE" ]; then
    if [ ${SYSNAME} == "Linux" ]; then
        PETSC_DIR="/usr/local/lib/python2.7/dist-packages/petsc"
    elif [ ${SYSNAME} == "Darwin" ]; then
        PETSC_DIR="/usr/local/Cellar/petsc/3.6.3"
    else
        echo "Unsupported platform: $SYSNAME"
        exit -1
    fi
fi

# check if PETSC_ARCH is set and set PETSC_INCLUDE and PETSC_LIB
DEFAULT_PETSC_ARCH=$(${R_HOME}/bin/Rscript -e 'cat(Sys.getenv("PETSC_ARCH")[1]=="")')

if [ ${DEFAULT_PETSC_ARCH} == "TRUE" ]; then
    PETSC_INCLUDE=-I${PETSC_DIR}/include
    PETSC_LIB=${PETSC_DIR}/lib 
else
    PETSC_INCLUDE=-I${PETSC_DIR}/include -I${PETSC_DIR}/${PETSC_ARCH}/include
    PETSC_LIB=${PETSC_DIR}/${PETSC_ARCH}/lib 
fi

export PETSC_LIB=${PETSC_LIB}

# check if MPI_INCLUDE is set
DEFAULT_MPI=$(${R_HOME}/bin/Rscript -e 'cat(Sys.getenv("MPI_INCLUDE")[1]=="")')

if [ ${DEFAULT_MPI} == "TRUE" ]; then

    # check if mpi.h lives on the system path
    MPI_NOT_ON_PATH=$(${R_HOME}/bin/Rscript -e 'cat(any(file.exists(file.path(strsplit(Sys.getenv("PATH")[1], ":")[[1]], "mpi.h")))==FALSE)')
    
    # if mpi.h does not live on the system path, use mpi.h that comes with PETSC
    if [ ${MPI_NOT_ON_PATH} == "TRUE" ]; then    
        MPI_INCLUDE=-I${PETSC_DIR}/include/petsc/mpiuni
    fi
    
else
    
    # MPI_INCLUDE was explicitly set, then let's use it
    MPI_INCLUDE=-I${MPI_INCLUDE}

fi

# check if we have the libraries installed
if [ ${SYSNAME} == "Darwin" ]; then
    
    # see if we can find libpetsc.dylib
    CHECK_PETSC=$(${R_HOME}/bin/Rscript -e 'cat(file.exists(file.path(Sys.getenv("PETSC_LIB"), "libpetsc.dylib")))')
    
    # this would be the place to download the binaries for osx
    if [ ${CHECK_PETSC} == FALSE ]; then
        echo "Cannot find libpetsc.$ext. Please make sure PETSc is installed and PETSC_LIB is appropriately set."
        exit -1
    fi
    
elif [ ${SYSNAME} == "Linux" ]; then
    
    # see if we can find libpetsc.so
    CHECK_PETSC=$(${R_HOME}/bin/Rscript -e 'cat(file.exists(file.path(Sys.getenv("PETSC_LIB"), "libpetsc.so")))')
    
    # this would be the place to download the headers and binaries for linux
    if [ ${CHECK_PETSC} == FALSE ]; then
        echo "Cannot find libpetsc.$ext. Please make sure PETSc is installed and PETSC_LIB is appropriately set."
        exit -1
    fi
fi

## create Makevars
sed -e"s|@PETSC_LIB@|"${PETSC_LIB}"|g" -e"s|@PETSC_INCLUDE@|"${PETSC_INCLUDE}"|g" -e"s|@MPI_INCLUDE@|"${MPI_INCLUDE}"|g" src/Makevars.in > src/Makevars

exit 0