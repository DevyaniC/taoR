#!/bin/bash

# This script was taken from Rblapi. All the credit goes to
# Dirk Eddelbuettel and Jeroen Ooms.
#
# https://github.com/Rblp/Rblpapi/blob/master/configure

# helper function for downloads
download() {
    url=${1}
    libcurl=$(${R_HOME}/bin/Rscript -e 'cat(capabilities()[["libcurl"]])')
    # when we have libcurl in R, use it -- else fall back to curl
    if [ ${libcurl} == "TRUE" ]; then
        file=$(basename ${url})
        ${R_HOME}/bin/Rscript -e "download.file(\"${url}\", \"${file}\", quiet=TRUE, method='libcurl')"
    else
        curl -s -k -L -O ${url}
    fi
}

sysname=$(${R_HOME}/bin/Rscript -e 'cat(Sys.info()["sysname"])')
if [ ${sysname} == "Linux" ]; then
    platform="linux"
elif [ ${sysname} == "Darwin" ]; then
    platform="osx"
else
    echo "Unsupported platform: $sysname"
    exit -1
fi

# all header files come with the package

# check if libpetsc lives on the (DY)LD_LIBRARY_PATH; in that case, 
# use it together with whatever mpi.h lives on the search path

# tbc

# if we can't find libpetsc, create the binaries and store them in /inst/lib
echo "Downloading and installing PETSc: this may take a while"
cd inst
download http://ftp.mcs.anl.gov/pub/petsc/release-snapshots/petsc-lite-3.6.3.tar.gz
echo "* Download completed"
tar xvf petsc-lite-3.6.3.tar.gz && rm petsc-lite-3.6.3.tar.gz && cd petsc-3.6.3
unset PETSC_DIR && unset PETSC_ARCH
PETSC_ARCH=arch-petscR
export PETSC_ARCH
CC=$(R CMD config CC)
CXX=$(R CMD config CXX)
FC=$(R CMD config FC)
./configure --with-cc=${CC} --with-cxx=${CXX} --with-fc=${FC} --download-fblaslapack --with-debugging=0 --with-mpi=0
echo "* configure step completed"
PETSC_DIR=$(${R_HOME}/bin/Rscript -e 'cat(getwd())')
make PETSC_DIR=${PETSC_DIR} PETSC_ARCH=${PETSC_ARCH} all
echo "* make step completed"
mkdir -p ../lib
mv ${PETSC_ARCH}/lib/libpetsc* ../lib
cd ..
rm -rf petsc-3.6.3
cd ..

rpath=$(${R_HOME}/bin/Rscript -e 'cat(file.path(.libPaths()[1], "taoR", "lib"))')
libpath=../inst/lib

sed -e"s|@rpath@|"${rpath}"|" -e"s|@libpath@|"${libpath}"|" -e"s|@petscarch@|"${PETSC_ARCH}"|" -e"s|@petscdir@|"${PETSC_DIR}"|" src/Makevars.in > src/Makevars

exit 0
